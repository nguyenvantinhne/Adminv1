<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MrTínhiOS - Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --secondary-color: #224abe;
      --success-color: #1cc88a;
      --danger-color: #e74a3b;
      --warning-color: #f6c23e;
      --dark-color: #5a5c69;
    }
    
    body {
      background-color: #f8f9fc;
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      height: 100vh;
    }
    
    .login-container {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .admin-container {
      display: none;
    }
    
    .card {
      border: none;
      border-radius: 0.35rem;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .sidebar {
      background: linear-gradient(180deg, var(--primary-color) 10%, var(--secondary-color) 100%);
      min-height: 100vh;
    }
    
    .sidebar-brand {
      height: 4.375rem;
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: 800;
      padding: 1.5rem 1rem;
      text-align: center;
      letter-spacing: 0.05rem;
      z-index: 1;
      color: #fff;
    }
    
    .sidebar-divider {
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin: 0 1rem 1rem;
    }
    
    .nav-item .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 1rem;
      font-weight: 600;
    }
    
    .nav-item .nav-link:hover {
      color: #fff;
    }
    
    .nav-item .nav-link i {
      margin-right: 0.25rem;
    }
    
    .nav-item.active .nav-link {
      color: #fff;
    }
    
    .bg-gradient-primary {
      background: linear-gradient(180deg, var(--primary-color) 10%, var(--secondary-color) 100%);
    }
    
    .status-badge {
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 700;
      border-radius: 0.25rem;
    }
    
    .badge-pending {
      background-color: #f6c23e;
      color: #000;
    }
    
    .badge-approved {
      background-color: #1cc88a;
      color: #fff;
    }
    
    .badge-rejected {
      background-color: #e74a3b;
      color: #fff;
    }
    
    .device-id {
      font-family: monospace;
      font-size: 0.8em;
      color: #6c757d;
    }
    
    .topbar {
      height: 4.375rem;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .dropdown-menu {
      border: none;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="container d-flex align-items-center justify-content-center" id="loginContainer">
    <div class="login-container">
      <div class="card o-hidden border-0 shadow-lg my-5">
        <div class="card-body p-0">
          <div class="p-5">
            <div class="text-center">
              <h1 class="h4 text-gray-900 mb-4">Admin Panel</h1>
              <p class="mb-4">Vui lòng đăng nhập để tiếp tục</p>
            </div>
            <form class="user" id="loginForm">
              <div class="form-group">
                <input type="text" class="form-control form-control-user" id="username" placeholder="Tên đăng nhập">
              </div>
              <div class="form-group">
                <input type="password" class="form-control form-control-user" id="password" placeholder="Mật khẩu">
              </div>
              <button type="submit" class="btn btn-primary btn-user btn-block">
                Đăng nhập
              </button>
            </form>
            <hr>
            <div class="text-center small text-danger" id="loginError"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel (Hidden until login) -->
  <div id="adminContainer" class="admin-container">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2">
        <div class="sidebar">
          <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <div class="sidebar-brand-icon">
              <i class="fas fa-lock"></i>
            </div>
            <div class="sidebar-brand-text mx-3">MrTínhiOS</div>
          </a>
          <div class="sidebar-divider"></div>
          <div class="nav-item">
            <a class="nav-link active" href="#">
              <i class="fas fa-fw fa-users"></i>
              <span>Quản lý tài khoản</span>
            </a>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#">
              <i class="fas fa-fw fa-laptop"></i>
              <span>Quản lý thiết bị</span>
            </a>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#">
              <i class="fas fa-fw fa-cog"></i>
              <span>Cài đặt hệ thống</span>
            </a>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">
              <i class="fas fa-fw fa-sign-out-alt"></i>
              <span>Đăng xuất</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-10">
        <!-- Topbar -->
        <nav class="navbar navbar-expand topbar mb-4 static-top bg-white">
          <h1 class="h3 mb-0 text-gray-800">Quản lý tài khoản đăng ký</h1>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                <span class="mr-2 d-none d-lg-inline text-gray-600 small" id="adminUsername">Admin</span>
                <i class="fas fa-user-circle fa-2x"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <a class="dropdown-item" href="#">
                  <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                  Thông tin cá nhân
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" id="logoutDropdownBtn">
                  <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                  Đăng xuất
                </a>
              </div>
            </li>
          </ul>
        </nav>

        <!-- Content Row -->
        <div class="container-fluid">
          <!-- Filter Section -->
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">Bộ lọc</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <label class="form-label">Trạng thái</label>
                  <select class="form-control" id="statusFilter">
                    <option value="all">Tất cả</option>
                    <option value="pending">Chờ duyệt</option>
                    <option value="approved">Đã duyệt</option>
                    <option value="rejected">Từ chối</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Từ ngày</label>
                  <input type="date" class="form-control" id="fromDate">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Đến ngày</label>
                  <input type="date" class="form-control" id="toDate">
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12 text-right">
                  <button class="btn btn-primary" id="applyFilterBtn">
                    <i class="fas fa-filter"></i> Áp dụng
                  </button>
                  <button class="btn btn-secondary" id="resetFilterBtn">
                    <i class="fas fa-redo"></i> Đặt lại
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- User Table -->
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">Danh sách tài khoản</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="userTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Tên</th>
                      <th>Email</th>
                      <th>Device ID</th>
                      <th>Ngày đăng ký</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="userTableBody">
                    <!-- Data will be loaded here -->
                    <tr>
                      <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Modals -->
  <div class="modal fade" id="approveModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Duyệt tài khoản</h5>
          <button type="button" class="close" data-bs-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Bạn có chắc chắn muốn duyệt tài khoản này?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-success" id="confirmApproveBtn">Duyệt</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="rejectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Từ chối tài khoản</h5>
          <button type="button" class="close" data-bs-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Bạn có chắc chắn muốn từ chối tài khoản này?</p>
          <div class="form-group">
            <label for="rejectReason">Lý do từ chối</label>
            <textarea class="form-control" id="rejectReason" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-danger" id="confirmRejectBtn">Từ chối</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Biến toàn cục
    let currentUser = null;
    let currentUserId = null;
    let authToken = null;
    const API_BASE_URL = window.location.origin;

    // Khởi tạo trang
    document.addEventListener('DOMContentLoaded', function() {
      // Kiểm tra nếu đã đăng nhập
      const savedToken = localStorage.getItem('adminAuthToken');
      if (savedToken) {
        verifyToken(savedToken);
      }

      // Xử lý đăng nhập
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        login();
      });

      // Xử lý đăng xuất
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('logoutDropdownBtn').addEventListener('click', logout);

      // Xử lý modal
      document.getElementById('confirmApproveBtn').addEventListener('click', approveUser);
      document.getElementById('confirmRejectBtn').addEventListener('click', rejectUser);

      // Xử lý filter
      document.getElementById('applyFilterBtn').addEventListener('click', loadUsers);
      document.getElementById('resetFilterBtn').addEventListener('click', resetFilters);
    });

    // Đăng nhập
    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorElement = document.getElementById('loginError');

      if (!username || !password) {
        errorElement.textContent = 'Vui lòng nhập đầy đủ thông tin';
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/admin/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          authToken = data.token;
          localStorage.setItem('adminAuthToken', authToken);
          currentUser = data.user;
          showAdminPanel();
        } else {
          errorElement.textContent = data.message || 'Đăng nhập thất bại';
        }
      } catch (error) {
        errorElement.textContent = 'Lỗi kết nối đến server';
        console.error('Login error:', error);
      }
    }

    // Xác thực token
    async function verifyToken(token) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/verify`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (data.success) {
          authToken = token;
          currentUser = data.user;
          showAdminPanel();
        } else {
          localStorage.removeItem('adminAuthToken');
        }
      } catch (error) {
        console.error('Token verification error:', error);
      }
    }

    // Hiển thị admin panel
    function showAdminPanel() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('adminContainer').style.display = 'block';
      document.getElementById('adminUsername').textContent = currentUser.username;
      loadUsers();
    }

    // Đăng xuất
    function logout() {
      localStorage.removeItem('adminAuthToken');
      authToken = null;
      currentUser = null;
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('adminContainer').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').textContent = '';
    }

    // Tải danh sách người dùng
    async function loadUsers() {
      const status = document.getElementById('statusFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      try {
        const response = await fetch(`${API_BASE_URL}/admin/users?status=${status}&from=${fromDate}&to=${toDate}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();

        if (data.success) {
          renderUserTable(data.users);
        } else {
          if (data.message === 'Unauthorized') {
            logout();
          }
          console.error('Error loading users:', data.message);
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Reset bộ lọc
    function resetFilters() {
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      loadUsers();
    }

    // Hiển thị bảng người dùng
    function renderUserTable(users) {
      const tbody = document.getElementById('userTableBody');
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Không có dữ liệu</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td><span class="device-id">${user.deviceId}</span></td>
          <td>${new Date(user.registerDate).toLocaleString()}</td>
          <td>
            <span class="status-badge ${getStatusBadgeClass(user.status)}">
              ${getStatusText(user.status)}
            </span>
          </td>
          <td>
            ${user.status === 'pending' ? `
              <button class="btn btn-sm btn-success me-2" onclick="showApproveModal(${user.id})">
                <i class="fas fa-check"></i> Duyệt
              </button>
              <button class="btn btn-sm btn-danger" onclick="showRejectModal(${user.id})">
                <i class="fas fa-times"></i> Từ chối
              </button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    // Hiển thị modal duyệt
    function showApproveModal(userId) {
      currentUserId = userId;
      const modal = new bootstrap.Modal(document.getElementById('approveModal'));
      modal.show();
    }

    // Hiển thị modal từ chối
    function showRejectModal(userId) {
      currentUserId = userId;
      document.getElementById('rejectReason').value = '';
      const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
      modal.show();
    }

    // Duyệt người dùng
    async function approveUser() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users/${currentUserId}/approve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
          loadUsers();
        } else {
          alert(data.message || 'Có lỗi xảy ra khi duyệt');
        }
      } catch (error) {
        console.error('Error approving user:', error);
        alert('Lỗi kết nối đến server');
      }
    }

    // Từ chối người dùng
    async function rejectUser() {
      const reason = document.getElementById('rejectReason').value.trim();
      
      if (!reason) {
        alert('Vui lòng nhập lý do từ chối');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/admin/users/${currentUserId}/reject`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
          loadUsers();
        } else {
          alert(data.message || 'Có lỗi xảy ra khi từ chối');
        }
      } catch (error) {
        console.error('Error rejecting user:', error);
        alert('Lỗi kết nối đến server');
      }
    }

    // Helper functions
    function getStatusBadgeClass(status) {
      switch (status) {
        case 'pending': return 'badge-pending';
        case 'approved': return 'badge-approved';
        case 'rejected': return 'badge-rejected';
        default: return '';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'pending': return 'Chờ duyệt';
        case 'approved': return 'Đã duyệt';
        case 'rejected': return 'Từ chối';
        default: return status;
      }
    }
  </script>
</body>
                  </html>
